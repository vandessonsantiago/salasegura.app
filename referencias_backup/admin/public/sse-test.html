<!doctype html>
<html>
  <head>
    <title>Teste SSE Direto</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
      }
      .log {
        margin: 5px 0;
        padding: 5px;
        background: #f0f0f0;
      }
      .success {
        background: #d4edda;
      }
      .error {
        background: #f8d7da;
      }
      .info {
        background: #d1ecf1;
      }
      button {
        margin: 5px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Teste SSE Direto (sem Next.js)</h1>

    <div>
      <button onclick="connectSSE()">Conectar SSE</button>
      <button onclick="disconnect()">Desconectar</button>
      <button onclick="clearLogs()">Limpar Logs</button>
    </div>

    <div id="status">Status: Desconectado</div>
    <div id="logs"></div>

    <script>
      let eventSource = null

      function log(message, type = "info") {
        const time = new Date().toLocaleTimeString()
        const logDiv = document.createElement("div")
        logDiv.className = `log ${type}`
        logDiv.textContent = `${time}: ${message}`
        document.getElementById("logs").appendChild(logDiv)
        console.log(`[${type.toUpperCase()}] ${message}`)
      }

      function setStatus(status) {
        document.getElementById("status").textContent = `Status: ${status}`
      }

      function connectSSE() {
        if (eventSource) {
          eventSource.close()
        }

        const testId = "test-direct-" + Date.now()
        const url =
          "http://localhost:3002/api/v1/payment-status/" + testId + "/stream"

        log("üîå Conectando: " + url)
        setStatus("Conectando...")

        try {
          eventSource = new EventSource(url)

          eventSource.onopen = function () {
            log("‚úÖ SSE conectado com sucesso!", "success")
            setStatus("Conectado")
          }

          eventSource.onmessage = function (event) {
            log("üì® Mensagem: " + event.data, "info")
            try {
              const data = JSON.parse(event.data)
              if (data.status) {
                setStatus("Conectado - Status: " + data.status)
              }
            } catch (e) {
              log("‚ùå Erro ao parsear: " + e.message, "error")
            }
          }

          eventSource.onerror = function (error) {
            log("‚ùå Erro SSE - ReadyState: " + eventSource.readyState, "error")
            setStatus("Erro")

            if (eventSource.readyState === EventSource.CLOSED) {
              log("üîí Conex√£o foi fechada pelo servidor", "error")
            }
          }
        } catch (error) {
          log("‚ùå Erro ao criar EventSource: " + error.message, "error")
          setStatus("Erro ao criar")
        }
      }

      function disconnect() {
        if (eventSource) {
          eventSource.close()
          eventSource = null
          log("üîå Desconectado manualmente", "info")
          setStatus("Desconectado")
        }
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = ""
      }
    </script>
  </body>
</html>
